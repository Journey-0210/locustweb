<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>压测任务审批后台</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
    h2 { color: #333; display: inline-block; }
    #logout { float: right; }
    table { width: 100%; border-collapse: collapse; background: #fff; margin-top: 20px; }
    th, td { padding: 8px 12px; border: 1px solid #ccc; text-align: center; }
    button { padding: 4px 8px; margin: 0 4px; cursor: pointer; }
  </style>
</head>
<body>

<h2>待审批压测任务</h2>
<button id="logout">退出登录</button>

<table>
  <thead>
  <tr>
    <th>用户ID</th>
    <th>并发用户数</th>
    <th>Ramp-Up (秒)</th>
    <th>压测时长 (秒)</th>
    <th>目标网址</th>
    <th>开始时间</th>
    <th>结束时间</th>
    <th>状态</th>
    <th>操作</th>
  </tr>
  </thead>
  <tbody id="taskBody"></tbody>
</table>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const token = localStorage.getItem("token");
    if (!token) {
      alert("请先登录");
      location.href = "/";
      return;
    }

    // 退出登录
    document.getElementById('logout').onclick = () => {
      localStorage.removeItem("token");
      location.href = "/";
    };

    // 加载待审批任务
    async function loadTasks() {
      const res = await fetch('/admin/tasks', {
        headers: { "Authorization": "Bearer " + token }
      });
      if (res.status === 403) {
        alert("你不是管理员或登录已过期");
        return;
      }
      if (!res.ok) {
        console.error("加载任务失败:", await res.text());
        return;
      }
      const { tasks } = await res.json();
      const tbody = document.getElementById("taskBody");
      tbody.innerHTML = "";

      tasks.forEach(task => {
        // 计算压测时长（秒）
        const duration = Math.floor((new Date(task.end_time) - new Date(task.start_time)) / 1000);

        // 格式化开始/结束时间
        const fmtStart = new Date(task.start_time).toLocaleString();
        const fmtEnd   = new Date(task.end_time).toLocaleString();

        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td>${task.user_id}</td>
            <td>${task.num_users}</td>
            <td>${task.ramp_up}</td>
            <td>${duration}</td>
            <td>${task.target_url}</td>
            <td>${fmtStart}</td>
            <td>${fmtEnd}</td>
            <td>${task.status}</td>
            <td>
              <button onclick="approveTask(${task.id})">通过</button>
              <button onclick="rejectTask(${task.id})">拒绝</button>
            </td>
          </tr>
        `);
      });
    }

    // 审批通过
    window.approveTask = async id => {
      const form = new URLSearchParams(); form.append("id", id);
      const res = await fetch('/admin/approve', {
        method: 'POST',
        headers: { "Authorization": "Bearer " + token },
        body: form
      });
      if (!res.ok) {
        alert("审批失败: " + await res.text());
        return;
      }
      alert("已通过任务ID: " + id);
      loadTasks();
    };

    // 审批拒绝
    window.rejectTask = async id => {
      const form = new URLSearchParams(); form.append("id", id);
      const res = await fetch('/admin/reject', {
        method: 'POST',
        headers: { "Authorization": "Bearer " + token },
        body: form
      });
      if (!res.ok) {
        alert("拒绝失败: " + await res.text());
        return;
      }
      alert("已拒绝任务ID: " + id);
      loadTasks();
    };

    loadTasks();
  });
</script>
</body>
</html>
